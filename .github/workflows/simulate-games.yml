name: Simulate Snake Games

on:
  push:
    branches-ignore:
      - main
    paths:
      - 'snakes/**'
      - '.github/workflows/simulate-games.yml'
      - 'script/simulate_royale'
      
  # trigger action on new pull request pushes
  pull_request:
    branches:
      - main
    paths:
      - 'snakes/**'
      - '.github/workflows/simulate-games.yml'
      - '.github/workflows/build-base.yml'
      - 'script/simulate_royale'
      - 'Dockerfile*'

jobs:

  build:

    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
    - uses: actions/checkout@v5
    
    - uses: actions/setup-go@v6
      with:
        go-version: '^1.17.1'
    
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
    
    - name: Install battlesnake CLI
      run: go install github.com/BattlesnakeOfficial/rules/cli/battlesnake@latest
    
    - name: Install Ruby dependencies
      run: |
        cd snakes/ruby/djdefi
        bundle install
    
    - name: Build Go snake
      run: |
        cd snakes/go/pathy-snake
        go build -o pathy-snake .
    
    - name: Start Ruby snake
      run: |
        cd snakes/ruby/djdefi
        bundle exec rackup --host 0.0.0.0 -p 4567 > /tmp/ruby-snake.log 2>&1 &
        echo $! > /tmp/ruby-pid.txt
    
    - name: Start Go snake
      run: |
        cd snakes/go/pathy-snake
        ./pathy-snake > /tmp/go-snake.log 2>&1 &
        echo $! > /tmp/go-pid.txt
    
    - name: Pause for 10 seconds
      run: sleep 10
    
    - name: Health check
      run: |
        echo "Checking Ruby snake..."
        curl -f http://localhost:4567/ || (cat /tmp/ruby-snake.log && exit 1)
        echo "‚úì Ruby snake healthy"
        
        echo "Checking Go snake..."
        curl -f http://localhost:8081/ || (cat /tmp/go-snake.log && exit 1)
        echo "‚úì Go snake healthy"

    - name: Simulate games
      id: simulate-games
      run: |
        for i in $(seq 1 10); do
          echo "Run [$i/10]"
          
          $(go env GOPATH)/bin/battlesnake play \
            -W 11 \
            -H 11 \
            --name ruby-danger-noodle \
            --url http://localhost:4567/ \
            --name pathy \
            --url http://localhost:8081/ \
            -g wrapped \
            -m hz_islands_bridges \
            --output /tmp/sim_output_$i.json 2>&1 | grep -E "(winner|draw)" || true
          
          if [ -f /tmp/sim_output_$i.json ]; then
            cat /tmp/sim_output_$i.json | jq -c 'if .isDraw then {winner: "draw"} else {winner: .winnerName} end' | tee -a simulate_royale.log
          fi
        done
    
    - name: Cleanup processes
      if: always()
      run: |
        if [ -f /tmp/ruby-pid.txt ]; then
          kill $(cat /tmp/ruby-pid.txt) 2>/dev/null || true
        fi
        if [ -f /tmp/go-pid.txt ]; then
          kill $(cat /tmp/go-pid.txt) 2>/dev/null || true
        fi

    - name: Set sim-log to var
      uses: actions/github-script@v8
      id: sim-log
      with:
        script: |
          const fs = require('fs');
          return fs.readFileSync('simulate_royale.log','utf8').toString();
        result-encoding: string

    - name: Post comment
      uses: mshick/add-pr-comment@v2
      with:
        message: |
            ü§ñ üêç:
            ${{ steps.sim-log.outputs.result }}
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        repo-token-user-login: 'github-actions[bot]' # The user.login for temporary GitHub tokens
        allow-repeats: false # This is the default, but let's be explicit
