name: Agentic Snake Improvement System

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
    inputs:
      improvement_focus:
        description: 'Focus area for improvement'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - food_seeking
          - collision_avoidance
          - positioning
          - aggression
      iterations:
        description: 'Number of improvement iterations'
        required: false
        default: '1'
        type: number

jobs:
  analyze_and_improve:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.ref }}
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      
      - name: Install dependencies
        run: |
          # Install system dependencies
          sudo apt-get update
          sudo apt-get install -y bc jq
          
          cd /home/runner/work/snakes/snakes/snakes/ruby/djdefi
          gem install bundler
          bundle install
          
          # Install battlesnake CLI
          go install github.com/BattlesnakeOfficial/rules/cli/battlesnake@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
      
      - name: Build Go snake
        run: |
          cd /home/runner/work/snakes/snakes/snakes/go/pathy-snake
          go build -o pathy-snake .
      
      - name: Run baseline simulations
        id: baseline
        run: |
          # Start Ruby snake
          cd /home/runner/work/snakes/snakes/snakes/ruby/djdefi
          bundle exec rackup --host 0.0.0.0 --port 4567 > /tmp/ruby-baseline.log 2>&1 &
          RUBY_PID=$!
          echo "ruby_pid=$RUBY_PID" >> $GITHUB_OUTPUT
          
          # Start Go snake
          cd /home/runner/work/snakes/snakes/snakes/go/pathy-snake
          ./pathy-snake --host 0.0.0.0 --port 8081 > /tmp/go-baseline.log 2>&1 &
          GO_PID=$!
          echo "go_pid=$GO_PID" >> $GITHUB_OUTPUT
          
          # Wait for snakes to start
          sleep 5
          
          # Verify endpoints
          curl -s http://localhost:4567/ || echo "Ruby snake not responding"
          curl -s http://localhost:8081/ || echo "Go snake not responding"
          
          # Run simulations
          RESULTS=""
          RUBY_WINS=0
          GO_WINS=0
          DRAWS=0
          
          GOPATH=$(go env GOPATH)
          BATTLESNAKE_BIN="${GOPATH}/bin/battlesnake"
          
          for i in $(seq 1 20); do
            OUTPUT=$("$BATTLESNAKE_BIN" play -W 11 -H 11 \
              --name ruby-danger-noodle --url http://localhost:4567/ \
              --name pathy --url http://localhost:8081/ \
              -g wrapped -v 2>&1 || true)
            
            if echo "$OUTPUT" | grep -q "ruby-danger-noodle is the winner"; then
              RUBY_WINS=$((RUBY_WINS + 1))
              RESULTS="${RESULTS}âœ…"
            elif echo "$OUTPUT" | grep -q "pathy is the winner"; then
              GO_WINS=$((GO_WINS + 1))
              RESULTS="${RESULTS}âŒ"
            else
              DRAWS=$((DRAWS + 1))
              RESULTS="${RESULTS}ðŸ¤"
            fi
          done
          
          TOTAL=20
          RUBY_WIN_RATE=$(awk -v wins="$RUBY_WINS" -v total="$TOTAL" 'BEGIN{printf "%.1f", (wins/total)*100}')
          
          echo "results=$RESULTS" >> $GITHUB_OUTPUT
          echo "ruby_wins=$RUBY_WINS" >> $GITHUB_OUTPUT
          echo "go_wins=$GO_WINS" >> $GITHUB_OUTPUT
          echo "draws=$DRAWS" >> $GITHUB_OUTPUT
          echo "win_rate=$RUBY_WIN_RATE" >> $GITHUB_OUTPUT
          
          # Cleanup
          kill $RUBY_PID $GO_PID || true
      
      - name: Analyze performance and generate improvement plan
        id: analyze
        env:
          RUBY_WINS: ${{ steps.baseline.outputs.ruby_wins }}
          WIN_RATE: ${{ steps.baseline.outputs.win_rate }}
          FOCUS: ${{ github.event.inputs.improvement_focus || 'auto' }}
        run: |
          cat > /tmp/analysis.md << 'ANALYSIS_EOF'
          # ðŸ¤– Agentic Analysis Report
          
          ## Baseline Performance
          - **Ruby Wins**: ${RUBY_WINS}/20 (${WIN_RATE}%)
          - **Performance Level**: $(
            if (( $(echo "$WIN_RATE < 30" | bc -l) )); then
              echo "âš ï¸ Poor - Needs significant improvement"
            elif (( $(echo "$WIN_RATE < 45" | bc -l) )); then
              echo "ðŸ“Š Moderate - Room for improvement"
            elif (( $(echo "$WIN_RATE < 60" | bc -l) )); then
              echo "âœ… Good - Minor optimizations possible"
            else
              echo "ðŸ† Excellent - Maintain and refine"
            fi
          )
          
          ## Improvement Recommendations
          
          ### Primary Focus Area: ${FOCUS}
          
          ANALYSIS_EOF
          
          # Determine improvement areas based on win rate
          if (( $(echo "$WIN_RATE < 30" | bc -l) )); then
            cat >> /tmp/analysis.md << 'REC_EOF'
          **Critical Issues Detected:**
          1. **Food Seeking**: Health management appears problematic
             - Lower health threshold further (60 â†’ 50)
             - Increase food score multiplier by 30%
             - Add starvation prevention logic
          
          2. **Collision Avoidance**: High death rate suggests collisions
             - Increase snake body penalties by 50%
             - Add predictive collision detection
             - Improve wall awareness
          
          3. **Space Control**: Likely getting trapped
             - Implement flood fill for space calculation
             - Prefer moves toward open areas
             - Avoid dead ends proactively
          REC_EOF
          
          elif (( $(echo "$WIN_RATE < 45" | bc -l) )); then
            cat >> /tmp/analysis.md << 'REC_EOF'
          **Moderate Improvements Needed:**
          1. **Food Seeking Optimization**:
             - Fine-tune health threshold (70 â†’ 65)
             - Increase food score by 20%
             - Improve pathfinding to food
          
          2. **Tactical Positioning**:
             - Better center control
             - Improved tail-chasing
             - Corner avoidance refinement
          
          3. **Opponent Awareness**:
             - Track snake lengths better
             - Aggressive pursuit of smaller snakes
             - Defensive play against larger snakes
          REC_EOF
          
          else
            cat >> /tmp/analysis.md << 'REC_EOF'
          **Fine-Tuning Recommendations**:
          1. **Endgame Optimization**:
             - Improve 1v1 strategies
             - Better space calculation in late game
             - Optimize for long-term survival
          
          2. **Efficiency Improvements**:
             - Reduce unnecessary moves
             - Optimize scoring weights
             - Improve decision speed
          REC_EOF
          fi
          
          cat >> /tmp/analysis.md << 'NEXT_EOF'
          
          ## Proposed Changes
          
          ### Task List (Natural Language):
          - [ ] Analyze current health threshold effectiveness
          - [ ] Adjust food scoring multipliers based on simulation data
          - [ ] Review collision penalties and increase if needed
          - [ ] Test corner/edge avoidance improvements
          - [ ] Validate changes don't break existing behavior
          - [ ] Run verification simulations (target: +10% win rate)
          
          ### Success Criteria:
          - Win rate improvement of at least 10 percentage points
          - No increase in early-game deaths
          - Maintained or improved late-game performance
          - All unit tests passing
          
          ## Next Actions
          1. Apply recommended code changes to `move.rb`
          2. Run verification simulations
          3. Compare results against baseline
          4. Iterate if target not met
          NEXT_EOF
          
          # Replace variables in analysis
          sed -i "s/\${RUBY_WINS}/$RUBY_WINS/g" /tmp/analysis.md
          sed -i "s/\${WIN_RATE}/$WIN_RATE/g" /tmp/analysis.md
          sed -i "s/\${FOCUS}/$FOCUS/g" /tmp/analysis.md
          
          cat /tmp/analysis.md
          
          # Determine if improvement needed
          if (( $(echo "$WIN_RATE < 45" | bc -l) )); then
            echo "needs_improvement=true" >> $GITHUB_OUTPUT
            echo "improvement_type=significant" >> $GITHUB_OUTPUT
          elif (( $(echo "$WIN_RATE < 55" | bc -l) )); then
            echo "needs_improvement=true" >> $GITHUB_OUTPUT
            echo "improvement_type=moderate" >> $GITHUB_OUTPUT
          else
            echo "needs_improvement=false" >> $GITHUB_OUTPUT
            echo "improvement_type=none" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate improvement recommendations
        if: steps.analyze.outputs.needs_improvement == 'true'
        id: recommend
        env:
          WIN_RATE: ${{ steps.baseline.outputs.win_rate }}
          IMPROVEMENT_TYPE: ${{ steps.analyze.outputs.improvement_type }}
        run: |
          cat > /tmp/recommendations.md << 'REC_END'
          # ðŸŽ¯ Automated Improvement Recommendations
          
          ## Code Changes Suggested
          
          Based on analysis, here are specific code modifications:
          
          ### File: `snakes/ruby/djdefi/app/move.rb`
          
          REC_END
          
          if [ "$IMPROVEMENT_TYPE" = "significant" ]; then
            cat >> /tmp/recommendations.md << 'CHANGES_EOF'
          #### Change 1: Lower Health Threshold
          ```ruby
          # Current: @health_threshold = 70
          # Proposed: @health_threshold = 50
          # Rationale: More aggressive food seeking to prevent starvation
          ```
          
          #### Change 2: Increase Food Scoring
          ```ruby
          # Current food multipliers
          # Wrapped: 65, Standard: 25
          # Proposed: Wrapped: 85, Standard: 35
          # Rationale: Prioritize food more heavily
          ```
          
          #### Change 3: Enhanced Collision Avoidance
          ```ruby
          # Increase snake body penalties by 50%
          # Current: -60 (wrapped), -150 (standard)
          # Proposed: -90 (wrapped), -225 (standard)
          ```
          CHANGES_EOF
          
          elif [ "$IMPROVEMENT_TYPE" = "moderate" ]; then
            cat >> /tmp/recommendations.md << 'CHANGES_EOF'
          #### Change 1: Fine-tune Health Threshold
          ```ruby
          # Current: @health_threshold = 70
          # Proposed: @health_threshold = 65
          # Rationale: Slightly more proactive food seeking
          ```
          
          #### Change 2: Adjust Food Scoring
          ```ruby
          # Increase food multipliers by 20%
          # Current Wrapped: 65 â†’ Proposed: 78
          # Current Standard: 25 â†’ Proposed: 30
          ```
          
          #### Change 3: Improve Positioning
          ```ruby
          # Increase corner penalties by 25%
          # Better center control scoring
          ```
          CHANGES_EOF
          fi
          
          cat >> /tmp/recommendations.md << 'TEST_EOF'
          
          ## Testing Protocol
          
          1. **Unit Tests**: Ensure all existing tests pass
          2. **Integration Tests**: Run 30+ simulation games
          3. **Performance Validation**: Verify win rate improvement
          4. **Regression Check**: Confirm no new failure modes
          
          ## Rollback Plan
          
          If changes degrade performance:
          - Revert commits immediately
          - Analyze failure modes
          - Adjust parameters more conservatively
          - Re-test incrementally
          TEST_EOF
          
          cat /tmp/recommendations.md
          
          echo "recommendations_generated=true" >> $GITHUB_OUTPUT
      
      - name: Create tracking issue
        if: steps.analyze.outputs.needs_improvement == 'true'
        uses: actions/github-script@v7
        env:
          ANALYSIS: ${{ steps.analyze.outputs }}
          BASELINE_RESULTS: ${{ steps.baseline.outputs.results }}
          WIN_RATE: ${{ steps.baseline.outputs.win_rate }}
          RUBY_WINS: ${{ steps.baseline.outputs.ruby_wins }}
          GO_WINS: ${{ steps.baseline.outputs.go_wins }}
        with:
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('/tmp/analysis.md', 'utf8');
            const recommendations = fs.readFileSync('/tmp/recommendations.md', 'utf8');
            
            const issueBody = `
            # ðŸ¤– Agentic Improvement Cycle - ${new Date().toISOString()}
            
            ## Baseline Simulation Results
            
            **Games**: 20  
            **Ruby Wins**: ${process.env.RUBY_WINS}  
            **Go Wins**: ${process.env.GO_WINS}  
            **Win Rate**: ${process.env.WIN_RATE}%
            
            **Results**: ${process.env.BASELINE_RESULTS}
            
            ---
            
            ${analysis}
            
            ---
            
            ${recommendations}
            
            ---
            
            ## Automated Actions
            
            - [ ] Review analysis and recommendations
            - [ ] Approve or modify suggested changes
            - [ ] Apply improvements to codebase
            - [ ] Run verification simulations
            - [ ] Update this issue with results
            
            **Next Scheduled Run**: In 6 hours
            
            _This issue was automatically generated by the Agentic Improvement System_
            `;
            
            // Check for existing open improvement issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'agentic-improvement',
              state: 'open'
            });
            
            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: issueBody
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ¤– Agentic Improvement Recommendations - ${new Date().toLocaleDateString()}`,
                body: issueBody,
                labels: ['agentic-improvement', 'snake-improvement', 'automated']
              });
            }
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agentic-analysis
          path: |
            /tmp/analysis.md
            /tmp/recommendations.md
            /tmp/ruby-baseline.log
            /tmp/go-baseline.log
          retention-days: 30
