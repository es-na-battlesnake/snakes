name: Agentic Snake Improvement

on:
  schedule:
    - cron: '0 */12 * * *'  # Every 12 hours
  workflow_dispatch:
    inputs:
      max_iterations:
        description: 'Maximum improvement iterations'
        required: false
        default: '3'
      target_win_rate:
        description: 'Target win rate (0-100)'
        required: false
        default: '45'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  agentic_improvement:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install battlesnake CLI
        run: |
          go install github.com/BattlesnakeOfficial/rules/cli/battlesnake@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          cd snakes/ruby/djdefi
          bundle install

      - name: Load agentic workflow definition
        id: load_workflow
        run: |
          echo "Loading agentic workflow definition..."
          if [ -f .github/workflows-agentic/improve-snake.yml ]; then
            echo "workflow_loaded=true" >> $GITHUB_OUTPUT
            # Extract target win rate from workflow definition
            TARGET=$(grep -A 3 "metric: \"win_rate\"" .github/workflows-agentic/improve-snake.yml | grep "threshold:" | awk '{print $2}' || echo "0.45")
            echo "target_win_rate=$TARGET" >> $GITHUB_OUTPUT
          else
            echo "workflow_loaded=false" >> $GITHUB_OUTPUT
            echo "target_win_rate=${{ github.event.inputs.target_win_rate || '45' }}" >> $GITHUB_OUTPUT
          fi

      - name: "TASK 1: Analyze Performance"
        id: analyze
        run: |
          echo "## ðŸ” Task 1: Analyze Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Goal**: Identify performance bottlenecks and improvement opportunities" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run baseline simulations
          cd /home/runner/work/snakes/snakes
          
          # Start Ruby snake
          cd snakes/ruby/djdefi
          bundle exec rackup --host 0.0.0.0 -p 4567 &
          RUBY_PID=$!
          echo "ruby_pid=$RUBY_PID" >> $GITHUB_OUTPUT
          
          # Start Go snake
          cd /home/runner/work/snakes/snakes/snakes/go/pathy-snake
          go run . --host 0.0.0.0 --port 8081 &
          GO_PID=$!
          echo "go_pid=$GO_PID" >> $GITHUB_OUTPUT
          
          # Wait for snakes to start
          sleep 5
          
          # Verify endpoints
          RUBY_OK=$(curl -s http://localhost:4567/ | grep -q "apiversion" && echo "true" || echo "false")
          GO_OK=$(curl -s http://localhost:8081/ | grep -q "apiversion" && echo "true" || echo "false")
          
          echo "Ruby snake: $RUBY_OK" >> $GITHUB_STEP_SUMMARY
          echo "Go snake: $GO_OK" >> $GITHUB_STEP_SUMMARY
          
          if [ "$RUBY_OK" = "true" ] && [ "$GO_OK" = "true" ]; then
            echo "âœ… Both snakes running" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Snake startup failed" >> $GITHUB_STEP_SUMMARY
            kill $RUBY_PID $GO_PID 2>/dev/null || true
            exit 1
          fi
          
          # Run 20 simulations for analysis
          cd /home/runner/work/snakes/snakes
          RESULTS=$(battlesnake play -W 11 -H 11 --name pathy --url http://localhost:8081/ --name ruby-danger-noodle --url http://localhost:4567/ -g wrapped --repeat 20 2>&1 || true)
          
          # Parse results
          RUBY_WINS=$(echo "$RESULTS" | grep -o "ruby-danger-noodle.*won" | wc -l || echo "0")
          PATHY_WINS=$(echo "$RESULTS" | grep -o "pathy.*won" | wc -l || echo "0")
          TOTAL=20
          
          if [ "$TOTAL" -gt 0 ]; then
            WIN_RATE=$(awk -v wins="$RUBY_WINS" -v total="$TOTAL" 'BEGIN{printf "%.1f", (wins/total)*100}')
          else
            WIN_RATE="0.0"
          fi
          
          echo "baseline_win_rate=$WIN_RATE" >> $GITHUB_OUTPUT
          echo "ruby_wins=$RUBY_WINS" >> $GITHUB_OUTPUT
          echo "pathy_wins=$PATHY_WINS" >> $GITHUB_OUTPUT
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Baseline Performance" >> $GITHUB_STEP_SUMMARY
          echo "- Ruby wins: $RUBY_WINS / $TOTAL ($WIN_RATE%)" >> $GITHUB_STEP_SUMMARY
          echo "- Pathy wins: $PATHY_WINS / $TOTAL" >> $GITHUB_STEP_SUMMARY
          
          # Cleanup
          kill $RUBY_PID $GO_PID 2>/dev/null || true

      - name: "TASK 2: Generate Improvement Recommendations"
        id: recommend
        run: |
          echo "## ðŸ’¡ Task 2: Improvement Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          WIN_RATE="${{ steps.analyze.outputs.baseline_win_rate }}"
          TARGET="${{ steps.load_workflow.outputs.target_win_rate }}"
          
          # Convert percentages to decimals for comparison
          WIN_RATE_DECIMAL=$(awk -v wr="$WIN_RATE" 'BEGIN{print wr/100}')
          TARGET_DECIMAL=$(awk -v t="$TARGET" 'BEGIN{print t/100}')
          
          echo "Current: $WIN_RATE% | Target: $TARGET%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Analyze current code and generate recommendations
          NEEDS_IMPROVEMENT=$(awk -v wr="$WIN_RATE_DECIMAL" -v target="$TARGET_DECIMAL" 'BEGIN{exit !(wr < target)}' && echo "true" || echo "false")
          echo "needs_improvement=$NEEDS_IMPROVEMENT" >> $GITHUB_OUTPUT
          
          if [ "$NEEDS_IMPROVEMENT" = "true" ]; then
            echo "### ðŸŽ¯ Recommended Improvements:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. **Food Seeking Optimization**" >> $GITHUB_STEP_SUMMARY
            echo "   - Current health threshold may need tuning" >> $GITHUB_STEP_SUMMARY
            echo "   - Expected impact: +5-10% win rate" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "2. **Collision Avoidance Enhancement**" >> $GITHUB_STEP_SUMMARY
            echo "   - Strengthen penalties for risky moves" >> $GITHUB_STEP_SUMMARY
            echo "   - Expected impact: +3-7% win rate" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "3. **Space Control Improvement**" >> $GITHUB_STEP_SUMMARY
            echo "   - Better endgame positioning" >> $GITHUB_STEP_SUMMARY
            echo "   - Expected impact: +2-5% win rate" >> $GITHUB_STEP_SUMMARY
            
            # Create detailed recommendation report
            cat > /tmp/improvement_recommendations.md << 'EOF'
# Agentic Improvement Recommendations

## Current Performance Analysis

**Win Rate**: $WIN_RATE%
**Target**: $TARGET%
**Gap**: $(awk -v t="$TARGET" -v w="$WIN_RATE" 'BEGIN{printf "%.1f", t-w}')%

## Recommended Changes

### Priority 1: Food Seeking Optimization
- Adjust health threshold for earlier food seeking
- Increase food score multipliers
- Add dynamic health-based urgency scaling

### Priority 2: Collision Avoidance
- Increase penalties for moves near other snakes
- Add head-to-head collision prediction
- Improve body segment avoidance

### Priority 3: Space Control  
- Better corner and edge handling
- Improved tail-chasing logic
- Strategic positioning for endgame

## Implementation Plan

1. Make targeted changes to `snakes/ruby/djdefi/app/move.rb`
2. Run validation simulations (30+ games)
3. Measure actual vs expected impact
4. Iterate if target not reached
EOF
            
            echo "recommendations_generated=true" >> $GITHUB_OUTPUT
          else
            echo "### âœ… Performance Target Achieved!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Current win rate ($WIN_RATE%) meets or exceeds target ($TARGET%)" >> $GITHUB_STEP_SUMMARY
            echo "recommendations_generated=false" >> $GITHUB_OUTPUT
          fi

      - name: "TASK 3: Validation Decision"
        id: decide
        run: |
          echo "## ðŸ¤” Task 3: Decision Making" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          NEEDS_IMPROVEMENT="${{ steps.recommend.outputs.needs_improvement }}"
          WIN_RATE="${{ steps.analyze.outputs.baseline_win_rate }}"
          TARGET="${{ steps.load_workflow.outputs.target_win_rate }}"
          
          if [ "$NEEDS_IMPROVEMENT" = "true" ]; then
            echo "### Decision: Continue Improvement Cycle" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Rationale**: Current win rate ($WIN_RATE%) below target ($TARGET%)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Actions**:" >> $GITHUB_STEP_SUMMARY
            echo "1. Review improvement recommendations" >> $GITHUB_STEP_SUMMARY
            echo "2. Implement highest-priority changes" >> $GITHUB_STEP_SUMMARY
            echo "3. Run validation simulations" >> $GITHUB_STEP_SUMMARY
            echo "4. Measure impact and iterate" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **Tip**: Check the tracking issue for detailed recommendations" >> $GITHUB_STEP_SUMMARY
            
            echo "decision=continue_improvement" >> $GITHUB_OUTPUT
            echo "action=create_improvement_issue" >> $GITHUB_OUTPUT
          else
            echo "### Decision: Performance Target Achieved" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Rationale**: Win rate ($WIN_RATE%) meets target ($TARGET%)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Actions**:" >> $GITHUB_STEP_SUMMARY
            echo "1. Monitor performance stability" >> $GITHUB_STEP_SUMMARY
            echo "2. Continue periodic validation" >> $GITHUB_STEP_SUMMARY
            echo "3. Maintain current optimization level" >> $GITHUB_STEP_SUMMARY
            
            echo "decision=maintain" >> $GITHUB_OUTPUT
            echo "action=report_success" >> $GITHUB_OUTPUT
          fi

      - name: "TASK 4: Create Improvement Issue"
        if: steps.decide.outputs.action == 'create_improvement_issue'
        uses: actions/github-script@v7
        with:
          script: |
            const winRate = '${{ steps.analyze.outputs.baseline_win_rate }}';
            const target = '${{ steps.load_workflow.outputs.target_win_rate }}';
            const rubyWins = '${{ steps.analyze.outputs.ruby_wins }}';
            const pathyWins = '${{ steps.analyze.outputs.pathy_wins }}';
            
            const issueBody = `## ðŸ¤– Agentic Improvement Cycle
            
            **Generated by**: Agentic Improvement Workflow
            **Date**: ${new Date().toISOString().split('T')[0]}
            **Run**: ${{ github.run_number }}
            
            ---
            
            ## ðŸ“Š Current Performance
            
            | Metric | Value |
            |--------|-------|
            | Win Rate | ${winRate}% |
            | Target | ${target}% |
            | Gap | ${(parseFloat(target) - parseFloat(winRate)).toFixed(1)}% |
            | Ruby Wins | ${rubyWins} / 20 |
            | Pathy Wins | ${pathyWins} / 20 |
            
            ---
            
            ## ðŸ’¡ Recommended Improvements
            
            ### Priority 1: Food Seeking Optimization
            - **Action**: Adjust health threshold for earlier food seeking
            - **Expected Impact**: +5-10% win rate
            - **Implementation**: Modify \`@health_threshold\` in \`move.rb\`
            
            ### Priority 2: Collision Avoidance Enhancement
            - **Action**: Strengthen penalties for risky moves
            - **Expected Impact**: +3-7% win rate  
            - **Implementation**: Increase penalty multipliers in collision detection
            
            ### Priority 3: Space Control Improvement
            - **Action**: Better endgame positioning
            - **Expected Impact**: +2-5% win rate
            - **Implementation**: Enhance corner/edge handling logic
            
            ---
            
            ## ðŸŽ¯ Success Criteria
            
            - [ ] Win rate reaches ${target}%
            - [ ] No regression in other metrics
            - [ ] All tests pass
            - [ ] Security scan passes
            
            ---
            
            ## ðŸ“ Implementation Plan
            
            1. Review current \`move.rb\` implementation
            2. Make targeted changes to address top recommendations
            3. Run validation simulations (30+ games)
            4. Measure actual vs expected impact
            5. If target reached: merge changes
            6. If target not reached: iterate with next priority
            
            ---
            
            ## ðŸ”— Resources
            
            - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Agentic Workflow Definition](.github/workflows-agentic/improve-snake.yml)
            - [Documentation](docs/CONTINUOUS_IMPROVEMENT.md)
            
            ---
            
            **Next automated run**: 12 hours from now
            **Manual trigger**: [Run workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/agentic-improvement.yml)
            `;
            
            // Check for existing improvement issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'agentic-improvement',
              state: 'open'
            });
            
            if (issues.data.length > 0) {
              // Update existing issue
              const issue = issues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `## ðŸ”„ Iteration Update\n\n${issueBody}`
              });
              core.info(`Updated existing issue #${issue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ¤– Agentic Improvement: Raise Win Rate to ${target}%`,
                body: issueBody,
                labels: ['agentic-improvement', 'snake-improvement', 'automation']
              });
              core.info(`Created new issue #${issue.data.number}`);
            }

      - name: "Cleanup"
        if: always()
        run: |
          # Kill any remaining snake processes
          pkill -f "rackup.*4567" || true
          pkill -f "go run.*8081" || true
